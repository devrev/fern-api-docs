## Snap-in code structure

A snap-in is a Node.js project with a specific structure:

```
- manifest.yaml
- code/
  - scripts/
  - src/
    - fixtures/
    - functions/
      - external-system/
      - extraction/
        - workers/
          - attachments-extraction.ts
          - data-extraction.ts
          - external-sync-units-extraction.ts
          - metadata-extraction.ts
        - index.ts
      - install_initial_domain_mapping/
      - loading/
        - workers/
          - load-data.ts
          - data-extraction.ts
          - external-sync-units-extraction.ts
          - metadata-extraction.ts
        - index.ts
    - test-runner/
  - test/
```

TODO: describe emitting events and invoking workers?

#### `manifest.yaml`

The snap-in manifest an essential part of a snap-in, as it's used to define a snap-in configuration: snap-in name, description, version, keyring types and functionality (functions).

#### `code/`

This folder contains the Node.js project.

#### `scripts/`

This folder includes scripts for deploying (`deploy.sh`) and building (`build.sh`) the snap-in using a Makefile.

#### `functions/`

This directory holds the snap-in's core logic. The logic for extracting data from the external system is found in the `extraction` folder, and the logic for loading data into the external system from DevRev is in the `loading` folder.

## Snap-in functionality

The DevRev platform enables the creation of a snap-in that can either import data from an external system into DevRev or export data from DevRev to an external system. Implementing both isn't necessary. The implemented functionalities are specified in `manifest.yaml` under the `functions` key, as shown in the starter template:

```yaml
functions:
  - name: extraction
    description: Extraction function for the template snap-in
  - name: loading
    description: Loading function for the template snap-in
  - name: install_initial_domain_mapping
    description: Create blueprint and install initial domain mapping
```

For example, removing the entry with the name loading means syncing from DevRev to the external system is not available in the UI.

### Extraction

Extraction is comprised of 4 phases, which follow sequentially:

1. external sync units extraction (only on initial import)
2. metadata extraction
3. data extraction
4. attachments extraction

#### External sync units extraction

In the external sync unit extraction phase, the snap-in is expected to obtain a list of external
sync units that it can extract from the external system API and send it to Airdrop in its response.

An _external sync unit_ refers to a single unit in the external system that is being airdropped to DevRev.
In some systems, this is a project; in some it is a repository; in support systems it could be
called a brand or an organization.
What a unit of data is called and what it represents depends on the external system's domain model.
It usually combines contacts, users, work-like items, and comments into a unit of domain objects.

Some external systems may offer a single unit in their free plans,
while their enterprise plans may offer their clients to operate many separate units.

The external sync unit ID is the identifier of the sync unit (project, repository, or similar)
in the external system.
For GitHub, this would be the repository, for example `cli` in `github.com/devrev/cli`.

#### Metadata extraction

During the metadata extraction phase, the Airdrop snap-in must provide an
`external_domain_metadata.json` file on each sync run.
This file provides a structured way of describing the external system's domain system,
including its domain entities, types, relationships, and other metadata.

#### Data extraction

In initial sync we need to extract all data to create a baseline while in subsequent runs only updated objects need to be extracted.

Snap-in should consult its internal state to determine what is already extracted and what it did not

#### Attachments extraction

For the attachment extraction phase of the import process, the extractor has to upload each attachment to DevRev

### Loading

TODO
