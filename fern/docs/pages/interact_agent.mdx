---
title: "DevRev Agents Async API Cookbook"
description: "A step-by-step guide for using DevRev's asynchronous API for agent execution"
---

# DevRev Agents Async API Cookbook

This cookbook provides a step-by-step guide to use the asynchronous API for DevRev agents. It assumes you've already created an agent using the DevRev agent builder platform.

## Table of Contents

- [Introduction](#introduction)
- [Setting Up Your Webhook](#setting-up-your-webhook)
- [Making Async API Calls](#making-async-api-calls)
- [Handling Webhook Events](#handling-webhook-events)
- [Implementation Patterns](#implementation-patterns)
  - [Custom Applications](#custom-applications)
  - [Talk To Agent Node in Workflows](#talk-to-agent-node-in-workflows)
  - [Snap-ins](#snap-ins)
- [Troubleshooting](#troubleshooting)

## Introduction

<Callout type="info">
  The DevRev Async API enables long-running agent executions without timeout
  concerns.
</Callout>

This DevRev async API enables you to execute agents without any execution timeout concerns. The execution occurs as an asynchronous workflow that sends events to you via webhooks. This approach ensures:

- Agent complexity does not bring timeout concerns with it
- Complete execution tracking via progress events
- Ability to handle long-running agent tasks

Disclaimer: In any unlikely and unforeseen circumstances, if an individual operation of the workflow times out, you will not receive an error event right now to notify that you should not to wait for any more messages. Its better to have a client side timeout for now while we brainstorm and fix this issue for you.

## Setting Up Your Webhook

Before using the async API, you need to create a webhook to receive agent execution events:

<Tabs>
  <TabItem value="curl" label="cURL">
    ```bash
    curl --location 'https://api.devrev.ai/internal/webhooks.create' \
    --header 'Content-Type: application/json' \
    --header 'Authorization: <YOUR_API_TOKEN>' \
    --data '{
        "url": "https://your-application.com/webhook-endpoint",
        "event_types": ["ai_agent_response"],
        "headers": [
          {
            "name": "x-api-key",
            "value": "your-secret-key"
          }
        ]
    }'
    ```
  </TabItem>
  <TabItem value="node" label="Node.js">
    ```javascript
    const axios = require('axios');

    async function createWebhook() {
      const response = await axios.post('https://api.devrev.ai/internal/webhooks.create', {
        url: "https://your-application.com/webhook-endpoint",
        event_types: ["ai_agent_response"],
        headers: [
          {
            name: "x-api-key",
            value: "your-secret-key"
          }
        ]
      }, {
        headers: {
          'Content-Type': 'application/json',
          'Authorization': '<YOUR_API_TOKEN>'
        }
      });

      return response.data;
    }
    ```

  </TabItem>
</Tabs>

Save the webhook ID from the response (format: `don:integration:dvrv-us-1:devo/0:webhook/auCJ7By8`). You'll need this when making async API calls.

Make sure that your webhook endpoint can appropriately respond to the verify events sent by DevRev to verify your webhook. This verify event will have a challenge string which you need to return in response. You should return the response like this:

<Tabs>
  <TabItem value="curl" label="cURL">
    ```json
    200 OK
    {
      "challenge": "DlrVaK7zRyZWwbJhj5dZHDlrVaK7Jhj5dZZjH"
    }
    ```
  </TabItem>
</Tabs>


You should follow the documentation provided for webhooks [here](https://developer.devrev.ai/public/guides/webhooks)

## Making Async API Calls

**Key parameters:**

- `agent`: Your agent's ID
- `event.input_message.message`: The query for your agent
- `session_object`: A unique identifier for the conversation session (maintains agent memory)
- `webhook_target.webhook`: The webhook ID created earlier
- `client_metadata`: Optional JSON data that will be returned verbatim in webhook events. This can be used to send metadata that will be required while processing the response events from the agent.

**To execute an agent asynchronously:**

<Tabs>
  <TabItem value="curl" label="cURL">
    ```bash
    curl --location 'https://api.devrev.ai/internal/ai-agents.events.execute-async' \
    --header 'Content-Type: application/json' \
    --header 'Accept: application/json' \
    --header 'Authorization: <YOUR_API_KEY>' \
    --data '{
      "agent": "don:core:dvrv-us-1:devo/0:ai_agent/1",
      "event": {
        "input_message": {
          "message": "Your query to the agent"
        }
      },
      "session_object": "unique_conversation_identifier",
      "webhook_target": {
        "webhook": "don:integration:dvrv-us-1:devo/0:webhook/auCJ7By8"
      },
      "client_metadata": {
         "user_id": "12345",
         "conversation_id": "conv-789"
      }
    }'
    ```
  </TabItem>
  <TabItem value="javascript" label="JavaScript">
    ```javascript
    const executeAgent = async () => {
      const response = await fetch('https://api.devrev.ai/internal/ai-agents.events.execute-async', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'Authorization': '<YOUR_API_KEY>'
        },
        body: JSON.stringify({
          agent: "don:core:dvrv-us-1:devo/0:ai_agent/1",
          event: {
            input_message: {
              message: "Your query to the agent"
            }
          },
          session_object: "unique_conversation_identifier",
          webhook_target: {
            webhook: "don:integration:dvrv-us-1:devo/0:webhook/auCJ7By8"
          },
          client_metadata: {
            user_id: "12345",
            conversation_id: "conv-789"
          }
        })
      });
      
      return await response.json();
    };
    ```
  </TabItem>
</Tabs>

<Callout type="warning">
  The session_object parameter is critical for maintaining conversation state
  across multiple calls.
</Callout>

## Handling Webhook Events

Your webhook endpoint will receive three types of events:

### 1. Progress Messages

These show which skills are being triggered and executed.

<Tabs>
  <TabItem value="triggered" label="Skill Triggered">
    ```json
    {
      "payload": {
        "ai_agent_response": {
          "agent": "don:core:dvrv-us-1:devo/xyz:ai_agent/123",
          "agent_response": "progress",
          "client_metadata": { /* your original metadata */ },
          "progress": {
            "progress_state": "skill_triggered",
            "skill_triggered": {
              "args": { /* skill arguments */ },
              "skill_name": "SkillName",
              "workflow": { /* This will not be populated if KnowledgeSearch skill is called */
                "display_id": "workflow-84",
                "id": "don:integration:dvrv-us-1:devo/xyz:workflow/84"
              }
            }
          },
          "session": "don:core:dvrv-us-1:devo/xyz:ai_agent_session/3810",
          "session_object": "unique_conversation_identifier"
        },
        "type": "ai_agent_response"
      }
    }
    ```
  </TabItem>
  <TabItem value="executed" label="Skill Executed">
    ```json
    {
      "payload": {
        "ai_agent_response": {
          "agent": "don:core:dvrv-us-1:devo/xyz:ai_agent/123",
          "agent_response": "progress",
          "client_metadata": { /* your original metadata */ },
          "progress": {
            "progress_state": "skill_executed",
            "skill_executed": {
              "output": { /* skill output */ },
              "skill_name": "SkillName"
            }
          },
          "session": "don:core:dvrv-us-1:devo/xyz:ai_agent_session/3810",
          "session_object": "unique_conversation_identifier"
        },
        "type": "ai_agent_response"
      }
    }
    ```
  </TabItem>
</Tabs>

### 2. Final Message

This event contains the agent's final response after all skills are executed.

```json
{
  "payload": {
    "ai_agent_response": {
      "agent": "don:core:dvrv-us-1:devo/xyz:ai_agent/123",
      "agent_response": "message",
      "client_metadata": {
        /* your original metadata */
      },
      "message": "The agent's final response message",
      "session": "don:core:dvrv-us-1:devo/xyz:ai_agent_session/3810",
      "session_object": "unique_conversation_identifier"
    },
    "type": "ai_agent_response"
  }
}
```

### 3. Error Message

This event indicates an error occurred during execution.

```json
{
  "payload": {
    "ai_agent_response": {
      "agent": "don:core:dvrv-us-1:devo/xyz:ai_agent/123",
      "agent_response": "error",
      "client_metadata": {
        /* your original metadata */
      },
      "error": {
        "error": "Error description"
      },
      "session": "don:core:dvrv-us-1:devo/xyz:ai_agent_session/3810",
      "session_object": "unique_conversation_identifier"
    },
    "type": "ai_agent_response"
  }
}
```

## Implementation Patterns

### Custom Applications

For building custom applications with the async API:

<Callout type="info">
  This pattern is ideal for custom chat interfaces, backend systems, or any
  application that needs to interact with DevRev agents.
</Callout>

1. Create a webhook endpoint in your application that can receive POST requests
2. Register this endpoint with DevRev using the webhooks.create API
3. Make async API calls with your agent ID and webhook ID
4. Process incoming webhook events to:
   - Track progress (optional)
   - Display the final agent response to the user
   - Handle any errors

Example flow for a chat application:

```javascript
// 1. When user sends a message
function handleUserMessage(message) {
  // Show loading indicator
  displayLoadingIndicator();

  // Make async API call
  fetch("https://api.devrev.ai/internal/ai-agents.events.execute-async", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: "YOUR_API_KEY",
    },
    body: JSON.stringify({
      agent: "your_agent_id",
      event: {
        input_message: {
          message: message,
        },
      },
      session_object: "conversation_" + userId,
      webhook_target: {
        webhook: "your_webhook_id",
      },
      client_metadata: {
        conversation_id: conversationId,
      },
    }),
  });
}

// 2. Webhook handler (server-side)
app.post("/webhook-endpoint", (req, res) => {
  const event = req.body;

  // Add handling for verify events

  const conversationId =
    event.payload.ai_agent_response.client_metadata.conversation_id;

  if (event.payload.ai_agent_response.agent_response === "message") {
    // Final message
    const message = event.payload.ai_agent_response.message;
    sendToClient(conversationId, {
      type: "agent_response",
      message: message,
    });
  } else if (event.payload.ai_agent_response.agent_response === "error") {
    // Error occurred
    sendToClient(conversationId, {
      type: "agent_error",
      error: event.payload.ai_agent_response.error.error,
    });
  }

  res.status(200).send("OK");
});
```

<Callout type="tip">
  Using WebSockets or Server-Sent Events can provide real-time updates to your
  UI as events are received.
</Callout>

### Talk To Agent Node in Workflows

**Note:** This is in early access, please contact support to have it enabled for you.

If you're using DevRev workflows:

<Callout type="info">
  The workflow engine handles the async API calls for you when using the Talk To
  Agent node.
</Callout>

1. Add the "Talk To Agent" node to your workflow 
2. Configure it with your agent ID
3. Connect it to response nodes to process the agent's output
4. The async API is used automatically by the workflow engine

### Snap-ins

For building snap-ins:

<Callout type="info">
  Snap-ins are the recommended way to extend DevRev with custom functionality.
</Callout>

1. Create a snap-in with at least two functions:

   - One to trigger the agent asynchronously
   - One to handle agent response events

2. In your manifest, map the functions to the correct event types:

```json
{
  "functions": [
    {
      "id": "trigger_agent",
      "description": "Trigger agent execution"
    },
    {
      "id": "handle_agent_response",
      "description": "Handle agent response events",
      "event_sources": [
        {
          "event_type": "ai_agent_response"
        }
      ]
    }
  ]
}
```

3. In your trigger function, use the event_source_target instead of webhook_target:

```javascript
function trigger_agent(context, event) {
  const res = await context.devrev.post('/internal/ai-agents.events.execute-async', {
    agent: 'your_agent_id',
    event: {
      input_message: {
        message: event.payload.message
      }
    },
    session_object: event.payload.conversation_id,
    event_source_target: {
      event_source: context.event_source
    },
    client_metadata: {
      conversation_id: event.payload.conversation_id
    }
  });

  return { status: "success" };
}

function handle_agent_response(context, event) {
  const agentResponse = event.payload.ai_agent_response;

  if (agentResponse.agent_response === 'message') {
    // Handle final message
  } else if (agentResponse.agent_response === 'progress') {
    // Handle progress message (optional)
  } else if (agentResponse.agent_response === 'error') {
    // Handle error
  }

  return { status: "success" };
}
```

## Troubleshooting

<Callout type="warning">Common issues and their solutions</Callout>

**Not receiving webhook events?**

- Verify your webhook URL is publicly accessible
- Check that you've registered for the "ai_agent_response" event type
- Ensure your server responds with a 2xx status code quickly

**Execution errors?**

- Check the error message in the error event
- Verify your agent ID is correct
- Ensure your session_object is a valid string

**Agent not responding as expected?**

- Review the skill_triggered and skill_executed events to see which skills were invoked
- Check if any skills returned error outputs
- Verify your agent's configuration in the DevRev agent builder