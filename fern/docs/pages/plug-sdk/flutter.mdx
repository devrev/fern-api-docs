This section describes the process of integrating the DevRev SDK with your Flutter app.

## Requirements

- Flutter 3.0.0 or higher.
- Dart 2.17.0 or later.
- A minimum deployment target of Android 5.0 (API level 21) or iOS 11.

## Installation

To install the DevRev SDK, run the following command:

```sh
flutter pub add devrev_sdk
```

## Set up the DevRev SDK

1. Open the DevRev web app at [https://app.devrev.ai](https://app.devrev.ai) and go to the **Settings** page.
2. Under **PLuG settings**, copy the value under **Your unique App ID**.
3. After obtaining the credentials, you can configure the DevRev SDK in your app.

<Callout intent="note">
The DevRev SDK must be configured before you can use any of its features.
</Callout>

The SDK will be ready for use once you execute the following configuration method:

```dart
DevRev.configure(appID);
```

## Identification

To access certain features of the DevRev SDK, user identification is required.

The identification function should be placed appropriately in your app after the user logs in. If you have the user information available at app launch, call the function after the `DevRev.configure(appID)` method.

<Callout intent="note">
On iOS, if you haven't previously identified the user, the DevRev SDK will automatically create an anonymous user for you immediately after the SDK is configured.
</Callout>

<Callout intent="note">
The `Identity` structure allows for custom fields in the user, organization, and account traits. These fields must be configured through the DevRev app before they can be utilized. For more information, refer to [Object customization](https://devrev.ai/docs/product/object-customization).
</Callout>

You can select from the following methods to identify users within your application:

### Anonymous identification

The anonymous identification method allows you to create an anonymous user with an optional user identifier, ensuring that no other data is stored or associated with the user.

```dart
DevRev.identifyAnonymousUser(userID);
```

### Unverified identification

The unverified identification method identifies users with a unique identifier, but it does not verify their identity with the DevRev backend.

```dart
DevRev.identifyUnverifiedUser(userID, organizationID);
```

### Verified identification

The verified identification method identifies users with a unique identifier and verifies their identity with the DevRev backend.

```dart
DevRev.identifyVerifiedUser(userID, sessionToken);
```

### Update the user

You can update the user's information using the following method:

```dart
DevRev.updateUser(identity);
```

<Callout intent="note">
The `userID` property cannot be updated.
</Callout>

### Logout

You can log out the current user by using the following method:

```dart
DevRev.logout(deviceID);
```

The user will be logged out by clearing their credentials, as well as unregistering the device from receiving push notifications, and stopping the session recording.

## PLuG support chat

Once user identification is complete, you can start using the chat (conversations) dialog supported by our DevRev SDK. The support chat feature can be shown as a modal screen from the top-most screen.

<Callout intent="note">
This functionality requires the SDK to be configured and the user to be identified, whether they are unverified or anonymous.
</Callout>

To show the support chat screen in your app, you can use the following method:

```dart
DevRev.showSupport();
```

### Creating a new support conversation

You can initiate a new support conversation directly from your app. This method displays the support chat screen and simultaneously creates a new conversation.

```dart
DevRev.createSupportConversation();
```

## Analytics

The DevRev SDK allows you to send custom analytic events by using a properties map. You can track these events using the following function:

<Callout intent="note">
This functionality requires the SDK to be configured and the user to be identified, whether they are unverified or anonymous.
</Callout>

```dart
DevRev.trackEvent(name, properties);
```

## Session analytics

The DevRev SDK offers session analytics features to help you understand how users interact with your app.

### Opting-in or out

Session analytics features are opted-in by default, enabling them from the start. However, you can opt-out using the following method:

```dart
DevRev.stopAllMonitoring();
```

To opt back in, use the following method:

```dart
DevRev.resumeAllMonitoring();
```

### Session recording

You can enable session recording to capture user interactions with your app.

<Callout intent="note">
The session recording feature is opt-out and is enabled by default.
</Callout>

The session recording feature includes the following methods to control the recording:

| Method                                                               | Action                                                    |
|--------------------------------------------------------------------|-----------------------------------------------------------|
|`DevRev.startRecording()`   | Starts the session recording.                             |
|`DevRev.stopRecording()`    | Ends the session recording and uploads it to the portal. |
|`DevRev.pauseRecording()`   | Pauses the ongoing session recording.                     |
|`DevRev.resumeRecording()`  | Resumes a paused session recording.                       |

### Session properties

You can add custom properties to the session recording to help you understand the context of the session. The properties are defined as a map of string values.

```dart
DevRev.addSessionProperties(properties);
```

To clear the session properties in scenarios such as user logout or when the session ends, use the following method: 

```dart
DevRev.clearSessionProperties();
```

### Timers

The DevRev SDK offers a timer mechanism to measure the time spent on specific tasks, allowing you to track events such as response time, loading time, or any other duration-based metrics.

The mechanism utilizes balanced start and stop methods, both of which accept a timer name and an optional dictionary of properties.

To start a timer, use the following method:

```dart
DevRev.startTimer(name, properties);
```

To stop a timer, use the following method:

```dart
DevRev.stopTimer(name, properties);
```

### Screen tracking

The DevRev SDK offers automatic screen tracking to help you understand how users navigate through your app. Although view controllers are automatically tracked, you can manually track screens using the following method:

```dart
DevRev.trackScreenName(screenName);
```

## Push notifications

You can configure your app to receive push notifications from the DevRev SDK. The SDK is designed to handle push notifications and execute actions based on the notification's content.

The DevRev backend sends push notifications to your app to alert users about new messages in the PLuG support chat.

### Configuration

To receive push notifications, you need to configure your DevRev organization by following the instructions in the [push notifications](https://developer.devrev.ai/public/sdks/mobile/push-notification) section.

### Register for push notifications

<Callout intent="note">
Push notifications require SDK configuration and user identification, whether unverified or anonymous, to ensure delivery to the correct user.
</Callout>

The DevRev SDK offers a method to register your device for receiving push notifications. You can register for push notifications using the following method:

```dart
DevRev.registerDeviceToken(deviceID, deviceToken);
```

On Android devices, the `deviceToken` should be the Firebase Cloud Messaging (FCM) token value, while on iOS devices, it should be the Apple Push Notification Service (APNS) token.

### Unregister from push notifications

If your app no longer needs to receive push notifications, you can unregister the device. 

Use the following method to unregister the device:

```dart
DevRev.unregisterDevice(deviceID);
```

### Processing push notifications

#### Android

On Android, notifications are implemented as data messages to offer flexibility. However, this means that automatic click processing isn't available. To handle notification clicks, developers need to intercept the click event, extract the payload, and pass it to a designated method for processing. This custom approach enables tailored notification handling in Android applications.

To process the notification, use the following method:

```dart
DevRev.processPushNotification(payload);
```

Here, the `message` object from the notification payload should be passed to this function.

For example:

```dart
final notificationPayload = {
	"message": {
		"title": "New Message",
		"body": "You have received a new message.",
		"data": {
			"messageId": "12345",
			"sender": "John Doe"
		}
	}
};

final messageJson = notificationPayload["message"];

if (messageJson != null) {
	DevRev.processPushNotification(jsonEncode(messageJson));
}
```

#### iOS

On iOS devices, you must pass the received push notification payload to the DevRev SDK for processing. The SDK will then handle the notification and execute the necessary actions. 

```dart
DevRev.processPushNotification(payload);
```

For example:

```dart
DevRev.processPushNotification(jsonEncode(payload));
```

## Troubleshooting

- **Issue**: Support chat won't show.  
	**Solution**: Ensure you have correctly called one of the identification methods: `DevRev.identifyUnverifiedUser(...)`, `DevRev.identifyVerifiedUser(...)`, or `DevRev.identifyAnonymousUser(...)`.

- **Issue**: Not receiving push notifications.  
	**Solution**: Ensure that your app is configured to receive push notifications and that your device is registered with the DevRev SDK.

## Migration Guide

This guide will help you transition from the legacy UserExperior SDK to the new DevRev SDK in your Flutter application. Below is a feature equivalence chart and detailed instructions for migrating.

### Feature Equivalence Chart

| Feature | UserExperior SDK | DevRev SDK |
|-|-|-|
| Installation | `user_experior: ^<version>` | `devrev_sdk_flutter: ^<version>` |
| Initialization | `userExperior.startRecording(appID)` | `DevRev.configure(appID)` |
| User Identification | `userExperior.setUserIdentifier(userIdentifier)` | `DevRev.identifyAnonymousUser(userID)`<br>`DevRev.identifyUnverifiedUser(userID, organizationID)`<br>`DevRev.identifyVerifiedUser(userID, sessionToken)`<br>`DevRev.logout(deviceID)` |
| Event Tracking | `userExperior.logEvent(name)` | `DevRev.trackEvent(name, properties)` |
| Session Recording | `userExperior.stopRecording()`<br>`userExperior.pauseRecording()`<br>`userExperior.resumeRecording()` | `DevRev.startRecording()`<br>`DevRev.stopRecording()`<br>`DevRev.pauseRecording()`<br>`DevRev.resumeRecording()`<br>`DevRev.processAllOnDemandSessions()` |
| Opting in/out | `userExperior.optOut()`<br>`userExperior.optIn()`<br>`userExperior.getOptOutStatus()` | `DevRev.stopAllMonitoring()`<br>`DevRev.resumeAllMonitoring()` |
| Session Properties | `userExperior.setUserProperties(properties)` | `DevRev.addSessionProperties(properties)`<br>`DevRev.clearSessionProperties()` |
| Timers | `userExperior.startTimer(timerName, properties)`<br>`userExperior.endTimer(timerName, properties)` | `DevRev.startTimer(name, properties)`<br>`DevRev.endTimer(name, properties)` |
| PLuG support chat | Not supported. | `DevRev.showSupport()`<br> `DevRev.createSupportConversation()` |
| Push Notifications | Not supported. | `DevRev.registerDeviceToken(deviceID, deviceToken)`<br>`DevRev.unregisterDevice(deviceID)` |

---
