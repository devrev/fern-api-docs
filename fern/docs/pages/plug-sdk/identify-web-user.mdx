Once you have [installed PLuG](./installation), all your users who interact with the widget are created as anonymous users in the DevRev app with a random name since there is no information about the user.

For users who are logged into your website, you can identify them in PLuG so they can view their past conversations. Identifying your users also enables more personalized engagement.

In this flow, you have to generate a session token for every user who visits your website. The session token identifies the customer when they interact with the widget. The session token is generated using the application access token and customer information. It should be generated on your website's back end since the app token needs to be kept hidden.

To identify logged-in users, follow these steps:

## Generate an application access token

1. In DevRev, go to **Settings > Support > PLuG Tokens** through the settings icon on the top-left corner.
2. Under the **Application access tokens** panel, click **New token** and copy the token that's displayed.

<Callout intent="note">
Ensure you copy your access token, as you will not be able to view it again.
</Callout>

## Generate a session token

<Callout intent="note">
For security reasons, this call should be made from the server side so that your AAT isn't exposed.
</Callout>

Using the `rev_info` method, you can generate and recognize a user within the DevRev system by providing relevant user details. This method enables you to convey information systematically, ensuring alignment between your DevRev CRM and the structured data model. For information regarding terminologies, click [here](https://devrev.ai/docs/product/grow).

```bash
curl --location 'https://api.devrev.ai/auth-tokens.create' \
--header 'accept: application/json, text/plain, */*' \
--header 'authorization: <AAT>' \
--header 'content-type: application/json' \
--data-raw '{
    "rev_info": {
        "user_ref": "example@devrev.ai",
        "account_ref": "devrev.ai",
        "workspace_ref": "devrev-dev",
        "user_traits": {
            "email": "test-user@devrev.ai",
            "display_name": "Devrev Test USer",
            "phone_numbers": ["+911122334455"],
            "custom_fields": {
               "tnt__<field1_name>": "value 1"
            }
        },
        "workspace_traits": {
            "display_name": "Devrev Dev",
            "custom_fields": {}
        },
        "account_traits": {
            "display_name": "Devrev",
            "domains": [
                "devrev.ai"
            ],
            "custom_fields": {
                "tnt__<field2_name>": "value x"
            }
        }
    }
}'
 ```

<Callout intent="note">
Ensure that you follow the specified format when providing your phone number.
</Callout>

## Pass custom attributes

To create custom attributes, see [Object customization](https://devrev.ai/docs/product/object-customization).

You can pass the custom attributes that are created as shown below:
```json

"custom_fields": {
  "tnt__custom_attribute_name1": <value>,
  "tnt__custom_attribute_name2": <value>,
}
 ```

You can pass custom traits, as shown above, not only for `users` but also for `workspaces` and `accounts`.

If you prefer a two-level structure, where users are directly associated with an account instead of a workspace, you can provide the `user_ref` and details along with the `account_ref` and details.

**Attributes for [users](https://developer.devrev.ai/public/api-reference/dev-users/product-builders-and-service-providers)**

| Attributes    | Description                                                                 | Type   | Required | Unique |
|---------------|-----------------------------------------------------------------------------|--------|----------|--------|
| user_ref      | A unique user reference that the DevRev app uses for identifying your users. This parameter is required. | string | ✅       | Yes    |
| email         | The email address of the customer. It's used for sending email notifications of any support messages. | string | ❌       | Yes     |
| display_name  | The name of the user that's shown on the widget.                          | string | ❌       | No     |
| phone_numbers | The customer's mobile number, which must adhere to the E.164 format.       | array  | ❌ *     | No     |

* If nothing is specified, a system-generated name will be assigned to the user.

**Attributes for [workspaces](https://developer.devrev.ai/public/api-reference/rev-orgs/workspaces)**                                              

| Attributes      | Description                                                                                                        | Type   | Required | Unique |
|-----------------|--------------------------------------------------------------------------------------------------------------------|--------|----------|--------|
| `workspace_ref` | A unique reference for the user's workspace. If not provided, and an account reference is passed, the user is directly attached to the account. | string | ❌        | ✅      |
| `display_name`  | The name of the workspace that's shown on the widget.                                                              | string | ❌        | ✅     |

**Attributes for [accounts](https://developer.devrev.ai/public/api-reference/accounts/accounts)**                                                        

| Attributes      | Description                                                                                                       | Type   | Required | Unique |
|-----------------|-------------------------------------------------------------------------------------------------------------------|--------|----------|--------|
| `account_ref`   | A unique reference for the account.                                                                               | string | ❌        | ✅      |
| `display_name`  | The name of the account that's shown on the widget.                                                               | string | ❌        | ✅     |
| `domains`       | Use a unique format like 'devrev.ai'. Formats such as 'https://devrev.ai' or 'www.devrev.ai' are not valid.       | array  | ❌        | ✅     |
| `phone_numbers` | The phone number associated with the account must be in E.164 format.                                             | array  | ❌        | -      |


### How resolution works

In a DevOrg, we utilize unique identifiers to handle objects. If an object doesn't exist, we create it and then attempt to link it. For example, here's how it operates:

User reference:
- A user reference is mandatory, ensuring its constant presence.
- If a user with the provided reference doesn't exist, the system automatically creates the user.

This approach ensures efficient management and integration of objects within the DevOrg.

| Workspace Ref | Account Ref | Results                                                                                              |
|---------------|-------------|------------------------------------------------------------------------------------------------------|
| ✅            | ✅          | If neither exists: System creates the account first, then creates the workspace. User is linked to both. |
|               |             | If account exists but workspace doesn't: System creates the workspace under the existing account. User is linked to both. |
|               |             | If workspace exists under different account: System returns an error, as workspaces cannot be moved between accounts. |
| ✅            | ❌          | If workspace doesn’t exist: System creates a new account and workspace (if needed). User is linked to both. |
| ❌            | ✅          | If the account doesn’t exist: An account is created, and the user is linked with the account.         |
| ❌            | ❌          | No action on account or workspace. The user is returned.                                              |



### Best practices

- Ensure the email field is filled out. This helps the support team accurately identify users and prevents duplicate entries when integrating with systems like email integration or outreach.
- If only an account and user are needed, you can omit workspace traits. This strategy helps prevent duplicate conflicts at the workspace level and maintains a clear object hierarchy.
- Ensure that unique attributes and reference identifiers (Refs) are aligned to avoid conflicts.

## Pass the session token 

While initializing the PLuG widget you pass the session token for DevRev to identify this user and thereby make the widget more customized for the user and their context.

```jsx
// You can generate this session token using the above API in your backend
const sessionToken = '<SESSION_TOKEN>'
<script type="text/javascript" src="https://plug-platform.devrev.ai/static/plug.js"></script>
<script>
    (() => {
      window.plugSDK.init({
        app_id: '<your_unique_app_id>',
          session_token: sessionToken
        })})();
</script>
```
